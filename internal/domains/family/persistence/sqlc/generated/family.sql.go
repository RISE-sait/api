// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: family.sql

package db_family

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"
)

const cancelRequest = `-- name: CancelRequest :exec
UPDATE users.parent_link_requests
SET cancelled_at = NOW()
WHERE id = $1
  AND completed_at IS NULL
  AND cancelled_at IS NULL
`

func (q *Queries) CancelRequest(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.ExecContext(ctx, cancelRequest, id)
	return err
}

const completeRequest = `-- name: CompleteRequest :one
UPDATE users.parent_link_requests
SET completed_at = NOW()
WHERE id = $1
RETURNING id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at
`

func (q *Queries) CompleteRequest(ctx context.Context, id uuid.UUID) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, completeRequest, id)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const createLinkRequest = `-- name: CreateLinkRequest :one
INSERT INTO users.parent_link_requests (
    child_id, new_parent_id, old_parent_id,
    initiated_by, verification_code, old_parent_code, expires_at
) VALUES ($1, $2, $3, $4, $5, $6, $7)
RETURNING id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at
`

type CreateLinkRequestParams struct {
	ChildID          uuid.UUID      `json:"child_id"`
	NewParentID      uuid.UUID      `json:"new_parent_id"`
	OldParentID      uuid.NullUUID  `json:"old_parent_id"`
	InitiatedBy      string         `json:"initiated_by"`
	VerificationCode string         `json:"verification_code"`
	OldParentCode    sql.NullString `json:"old_parent_code"`
	ExpiresAt        time.Time      `json:"expires_at"`
}

func (q *Queries) CreateLinkRequest(ctx context.Context, arg CreateLinkRequestParams) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, createLinkRequest,
		arg.ChildID,
		arg.NewParentID,
		arg.OldParentID,
		arg.InitiatedBy,
		arg.VerificationCode,
		arg.OldParentCode,
		arg.ExpiresAt,
	)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const getChildrenByParentId = `-- name: GetChildrenByParentId :many
SELECT id, first_name, last_name, email, created_at
FROM users.users
WHERE parent_id = $1 AND deleted_at IS NULL
`

type GetChildrenByParentIdRow struct {
	ID        uuid.UUID      `json:"id"`
	FirstName string         `json:"first_name"`
	LastName  string         `json:"last_name"`
	Email     sql.NullString `json:"email"`
	CreatedAt time.Time      `json:"created_at"`
}

func (q *Queries) GetChildrenByParentId(ctx context.Context, parentID uuid.NullUUID) ([]GetChildrenByParentIdRow, error) {
	rows, err := q.db.QueryContext(ctx, getChildrenByParentId, parentID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetChildrenByParentIdRow
	for rows.Next() {
		var i GetChildrenByParentIdRow
		if err := rows.Scan(
			&i.ID,
			&i.FirstName,
			&i.LastName,
			&i.Email,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getPendingRequestByChildId = `-- name: GetPendingRequestByChildId :one
SELECT id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at FROM users.parent_link_requests
WHERE child_id = $1
  AND completed_at IS NULL
  AND cancelled_at IS NULL
  AND expires_at > NOW()
`

func (q *Queries) GetPendingRequestByChildId(ctx context.Context, childID uuid.UUID) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, getPendingRequestByChildId, childID)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const getPendingRequestsForUser = `-- name: GetPendingRequestsForUser :many
SELECT plr.id, plr.child_id, plr.new_parent_id, plr.old_parent_id, plr.initiated_by, plr.verification_code, plr.verified_at, plr.old_parent_code, plr.old_parent_verified_at, plr.expires_at, plr.completed_at, plr.cancelled_at, plr.created_at,
       c.first_name as child_first_name,
       c.last_name as child_last_name,
       c.email as child_email,
       np.first_name as new_parent_first_name,
       np.last_name as new_parent_last_name,
       np.email as new_parent_email,
       op.first_name as old_parent_first_name,
       op.last_name as old_parent_last_name,
       op.email as old_parent_email
FROM users.parent_link_requests plr
JOIN users.users c ON c.id = plr.child_id
JOIN users.users np ON np.id = plr.new_parent_id
LEFT JOIN users.users op ON op.id = plr.old_parent_id
WHERE (plr.child_id = $1 OR plr.new_parent_id = $1 OR plr.old_parent_id = $1)
  AND plr.completed_at IS NULL
  AND plr.cancelled_at IS NULL
  AND plr.expires_at > NOW()
ORDER BY plr.created_at DESC
`

type GetPendingRequestsForUserRow struct {
	ID                  uuid.UUID      `json:"id"`
	ChildID             uuid.UUID      `json:"child_id"`
	NewParentID         uuid.UUID      `json:"new_parent_id"`
	OldParentID         uuid.NullUUID  `json:"old_parent_id"`
	InitiatedBy         string         `json:"initiated_by"`
	VerificationCode    string         `json:"verification_code"`
	VerifiedAt          sql.NullTime   `json:"verified_at"`
	OldParentCode       sql.NullString `json:"old_parent_code"`
	OldParentVerifiedAt sql.NullTime   `json:"old_parent_verified_at"`
	ExpiresAt           time.Time      `json:"expires_at"`
	CompletedAt         sql.NullTime   `json:"completed_at"`
	CancelledAt         sql.NullTime   `json:"cancelled_at"`
	CreatedAt           time.Time      `json:"created_at"`
	ChildFirstName      string         `json:"child_first_name"`
	ChildLastName       string         `json:"child_last_name"`
	ChildEmail          sql.NullString `json:"child_email"`
	NewParentFirstName  string         `json:"new_parent_first_name"`
	NewParentLastName   string         `json:"new_parent_last_name"`
	NewParentEmail      sql.NullString `json:"new_parent_email"`
	OldParentFirstName  sql.NullString `json:"old_parent_first_name"`
	OldParentLastName   sql.NullString `json:"old_parent_last_name"`
	OldParentEmail      sql.NullString `json:"old_parent_email"`
}

func (q *Queries) GetPendingRequestsForUser(ctx context.Context, childID uuid.UUID) ([]GetPendingRequestsForUserRow, error) {
	rows, err := q.db.QueryContext(ctx, getPendingRequestsForUser, childID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []GetPendingRequestsForUserRow
	for rows.Next() {
		var i GetPendingRequestsForUserRow
		if err := rows.Scan(
			&i.ID,
			&i.ChildID,
			&i.NewParentID,
			&i.OldParentID,
			&i.InitiatedBy,
			&i.VerificationCode,
			&i.VerifiedAt,
			&i.OldParentCode,
			&i.OldParentVerifiedAt,
			&i.ExpiresAt,
			&i.CompletedAt,
			&i.CancelledAt,
			&i.CreatedAt,
			&i.ChildFirstName,
			&i.ChildLastName,
			&i.ChildEmail,
			&i.NewParentFirstName,
			&i.NewParentLastName,
			&i.NewParentEmail,
			&i.OldParentFirstName,
			&i.OldParentLastName,
			&i.OldParentEmail,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getRequestById = `-- name: GetRequestById :one
SELECT id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at FROM users.parent_link_requests
WHERE id = $1
`

func (q *Queries) GetRequestById(ctx context.Context, id uuid.UUID) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, getRequestById, id)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const getRequestByOldParentCode = `-- name: GetRequestByOldParentCode :one
SELECT id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at FROM users.parent_link_requests
WHERE old_parent_code = $1
  AND completed_at IS NULL
  AND cancelled_at IS NULL
  AND expires_at > NOW()
`

func (q *Queries) GetRequestByOldParentCode(ctx context.Context, oldParentCode sql.NullString) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, getRequestByOldParentCode, oldParentCode)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const getRequestByVerificationCode = `-- name: GetRequestByVerificationCode :one
SELECT id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at FROM users.parent_link_requests
WHERE verification_code = $1
  AND completed_at IS NULL
  AND cancelled_at IS NULL
  AND expires_at > NOW()
`

func (q *Queries) GetRequestByVerificationCode(ctx context.Context, verificationCode string) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, getRequestByVerificationCode, verificationCode)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const getUserByEmail = `-- name: GetUserByEmail :one
SELECT id, first_name, last_name, email, parent_id
FROM users.users
WHERE email = $1 AND deleted_at IS NULL
`

type GetUserByEmailRow struct {
	ID        uuid.UUID      `json:"id"`
	FirstName string         `json:"first_name"`
	LastName  string         `json:"last_name"`
	Email     sql.NullString `json:"email"`
	ParentID  uuid.NullUUID  `json:"parent_id"`
}

func (q *Queries) GetUserByEmail(ctx context.Context, email sql.NullString) (GetUserByEmailRow, error) {
	row := q.db.QueryRowContext(ctx, getUserByEmail, email)
	var i GetUserByEmailRow
	err := row.Scan(
		&i.ID,
		&i.FirstName,
		&i.LastName,
		&i.Email,
		&i.ParentID,
	)
	return i, err
}

const getUserById = `-- name: GetUserById :one
SELECT id, first_name, last_name, email, parent_id
FROM users.users
WHERE id = $1 AND deleted_at IS NULL
`

type GetUserByIdRow struct {
	ID        uuid.UUID      `json:"id"`
	FirstName string         `json:"first_name"`
	LastName  string         `json:"last_name"`
	Email     sql.NullString `json:"email"`
	ParentID  uuid.NullUUID  `json:"parent_id"`
}

func (q *Queries) GetUserById(ctx context.Context, id uuid.UUID) (GetUserByIdRow, error) {
	row := q.db.QueryRowContext(ctx, getUserById, id)
	var i GetUserByIdRow
	err := row.Scan(
		&i.ID,
		&i.FirstName,
		&i.LastName,
		&i.Email,
		&i.ParentID,
	)
	return i, err
}

const isUserChild = `-- name: IsUserChild :one
SELECT parent_id IS NOT NULL as is_child
FROM users.users
WHERE id = $1 AND deleted_at IS NULL
`

func (q *Queries) IsUserChild(ctx context.Context, id uuid.UUID) (interface{}, error) {
	row := q.db.QueryRowContext(ctx, isUserChild, id)
	var is_child interface{}
	err := row.Scan(&is_child)
	return is_child, err
}

const markOldParentVerified = `-- name: MarkOldParentVerified :one
UPDATE users.parent_link_requests
SET old_parent_verified_at = NOW()
WHERE id = $1
RETURNING id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at
`

func (q *Queries) MarkOldParentVerified(ctx context.Context, id uuid.UUID) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, markOldParentVerified, id)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const markVerified = `-- name: MarkVerified :one
UPDATE users.parent_link_requests
SET verified_at = NOW()
WHERE id = $1
RETURNING id, child_id, new_parent_id, old_parent_id, initiated_by, verification_code, verified_at, old_parent_code, old_parent_verified_at, expires_at, completed_at, cancelled_at, created_at
`

func (q *Queries) MarkVerified(ctx context.Context, id uuid.UUID) (UsersParentLinkRequest, error) {
	row := q.db.QueryRowContext(ctx, markVerified, id)
	var i UsersParentLinkRequest
	err := row.Scan(
		&i.ID,
		&i.ChildID,
		&i.NewParentID,
		&i.OldParentID,
		&i.InitiatedBy,
		&i.VerificationCode,
		&i.VerifiedAt,
		&i.OldParentCode,
		&i.OldParentVerifiedAt,
		&i.ExpiresAt,
		&i.CompletedAt,
		&i.CancelledAt,
		&i.CreatedAt,
	)
	return i, err
}

const removeChildParent = `-- name: RemoveChildParent :exec
UPDATE users.users
SET parent_id = NULL, updated_at = NOW()
WHERE id = $1
`

func (q *Queries) RemoveChildParent(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.ExecContext(ctx, removeChildParent, id)
	return err
}

const updateChildParent = `-- name: UpdateChildParent :exec
UPDATE users.users
SET parent_id = $2, updated_at = NOW()
WHERE id = $1
`

type UpdateChildParentParams struct {
	ID       uuid.UUID     `json:"id"`
	ParentID uuid.NullUUID `json:"parent_id"`
}

func (q *Queries) UpdateChildParent(ctx context.Context, arg UpdateChildParentParams) error {
	_, err := q.db.ExecContext(ctx, updateChildParent, arg.ID, arg.ParentID)
	return err
}
