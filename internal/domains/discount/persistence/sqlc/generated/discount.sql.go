// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.27.0
// source: discount.sql

package db_discount

import (
	"context"
	"database/sql"
	"time"

	"github.com/google/uuid"
)

const createDiscount = `-- name: CreateDiscount :one
INSERT INTO discounts (
    name, description, discount_percent, discount_amount, discount_type,
    is_use_unlimited, use_per_client, is_active, valid_from, valid_to,
    duration_type, duration_months, applies_to, max_redemptions, stripe_coupon_id, stripe_promotion_code_id
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16
) RETURNING id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id
`

type CreateDiscountParams struct {
	Name                  string         `json:"name"`
	Description           sql.NullString `json:"description"`
	DiscountPercent       int32          `json:"discount_percent"`
	DiscountAmount        sql.NullString `json:"discount_amount"`
	DiscountType          string         `json:"discount_type"`
	IsUseUnlimited        bool           `json:"is_use_unlimited"`
	UsePerClient          sql.NullInt32  `json:"use_per_client"`
	IsActive              bool           `json:"is_active"`
	ValidFrom             time.Time      `json:"valid_from"`
	ValidTo               sql.NullTime   `json:"valid_to"`
	DurationType          string         `json:"duration_type"`
	DurationMonths        sql.NullInt32  `json:"duration_months"`
	AppliesTo             string         `json:"applies_to"`
	MaxRedemptions        sql.NullInt32  `json:"max_redemptions"`
	StripeCouponID        sql.NullString `json:"stripe_coupon_id"`
	StripePromotionCodeID sql.NullString `json:"stripe_promotion_code_id"`
}

func (q *Queries) CreateDiscount(ctx context.Context, arg CreateDiscountParams) (Discount, error) {
	row := q.db.QueryRowContext(ctx, createDiscount,
		arg.Name,
		arg.Description,
		arg.DiscountPercent,
		arg.DiscountAmount,
		arg.DiscountType,
		arg.IsUseUnlimited,
		arg.UsePerClient,
		arg.IsActive,
		arg.ValidFrom,
		arg.ValidTo,
		arg.DurationType,
		arg.DurationMonths,
		arg.AppliesTo,
		arg.MaxRedemptions,
		arg.StripeCouponID,
		arg.StripePromotionCodeID,
	)
	var i Discount
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.DiscountPercent,
		&i.DiscountAmount,
		&i.DiscountType,
		&i.IsUseUnlimited,
		&i.UsePerClient,
		&i.IsActive,
		&i.ValidFrom,
		&i.ValidTo,
		&i.DurationType,
		&i.DurationMonths,
		&i.AppliesTo,
		&i.MaxRedemptions,
		&i.TimesRedeemed,
		&i.StripeCouponID,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.StripePromotionCodeID,
	)
	return i, err
}

const deleteDiscount = `-- name: DeleteDiscount :execrows
DELETE FROM discounts WHERE id = $1
`

func (q *Queries) DeleteDiscount(ctx context.Context, id uuid.UUID) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteDiscount, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const getDiscountById = `-- name: GetDiscountById :one
SELECT id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id FROM discounts WHERE id = $1
`

func (q *Queries) GetDiscountById(ctx context.Context, id uuid.UUID) (Discount, error) {
	row := q.db.QueryRowContext(ctx, getDiscountById, id)
	var i Discount
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.DiscountPercent,
		&i.DiscountAmount,
		&i.DiscountType,
		&i.IsUseUnlimited,
		&i.UsePerClient,
		&i.IsActive,
		&i.ValidFrom,
		&i.ValidTo,
		&i.DurationType,
		&i.DurationMonths,
		&i.AppliesTo,
		&i.MaxRedemptions,
		&i.TimesRedeemed,
		&i.StripeCouponID,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.StripePromotionCodeID,
	)
	return i, err
}

const getDiscountByName = `-- name: GetDiscountByName :one
SELECT id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id FROM discounts WHERE name = $1
`

func (q *Queries) GetDiscountByName(ctx context.Context, name string) (Discount, error) {
	row := q.db.QueryRowContext(ctx, getDiscountByName, name)
	var i Discount
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.DiscountPercent,
		&i.DiscountAmount,
		&i.DiscountType,
		&i.IsUseUnlimited,
		&i.UsePerClient,
		&i.IsActive,
		&i.ValidFrom,
		&i.ValidTo,
		&i.DurationType,
		&i.DurationMonths,
		&i.AppliesTo,
		&i.MaxRedemptions,
		&i.TimesRedeemed,
		&i.StripeCouponID,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.StripePromotionCodeID,
	)
	return i, err
}

const getDiscountByNameActive = `-- name: GetDiscountByNameActive :one
SELECT id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id FROM discounts
WHERE name = $1
  AND is_active = true
  AND valid_from <= now()
  AND (valid_to IS NULL OR valid_to >= now())
`

func (q *Queries) GetDiscountByNameActive(ctx context.Context, name string) (Discount, error) {
	row := q.db.QueryRowContext(ctx, getDiscountByNameActive, name)
	var i Discount
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.DiscountPercent,
		&i.DiscountAmount,
		&i.DiscountType,
		&i.IsUseUnlimited,
		&i.UsePerClient,
		&i.IsActive,
		&i.ValidFrom,
		&i.ValidTo,
		&i.DurationType,
		&i.DurationMonths,
		&i.AppliesTo,
		&i.MaxRedemptions,
		&i.TimesRedeemed,
		&i.StripeCouponID,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.StripePromotionCodeID,
	)
	return i, err
}

const getRestrictedPlans = `-- name: GetRestrictedPlans :many
SELECT membership_plan_id FROM membership.discount_restricted_membership_plans
WHERE discount_id = $1
`

func (q *Queries) GetRestrictedPlans(ctx context.Context, discountID uuid.UUID) ([]uuid.UUID, error) {
	rows, err := q.db.QueryContext(ctx, getRestrictedPlans, discountID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []uuid.UUID
	for rows.Next() {
		var membership_plan_id uuid.UUID
		if err := rows.Scan(&membership_plan_id); err != nil {
			return nil, err
		}
		items = append(items, membership_plan_id)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getUsageCount = `-- name: GetUsageCount :one
SELECT usage_count FROM users.customer_discount_usage WHERE customer_id = $1 AND discount_id = $2
`

type GetUsageCountParams struct {
	CustomerID uuid.UUID `json:"customer_id"`
	DiscountID uuid.UUID `json:"discount_id"`
}

func (q *Queries) GetUsageCount(ctx context.Context, arg GetUsageCountParams) (int32, error) {
	row := q.db.QueryRowContext(ctx, getUsageCount, arg.CustomerID, arg.DiscountID)
	var usage_count int32
	err := row.Scan(&usage_count)
	return usage_count, err
}

const incrementUsage = `-- name: IncrementUsage :execrows
INSERT INTO users.customer_discount_usage (customer_id, discount_id)
VALUES ($1, $2)
ON CONFLICT (customer_id, discount_id) DO UPDATE
SET usage_count = users.customer_discount_usage.usage_count + 1,
    last_used_at = CURRENT_TIMESTAMP
`

type IncrementUsageParams struct {
	CustomerID uuid.UUID `json:"customer_id"`
	DiscountID uuid.UUID `json:"discount_id"`
}

func (q *Queries) IncrementUsage(ctx context.Context, arg IncrementUsageParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, incrementUsage, arg.CustomerID, arg.DiscountID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const listDiscounts = `-- name: ListDiscounts :many
SELECT id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id FROM discounts ORDER BY created_at DESC
`

func (q *Queries) ListDiscounts(ctx context.Context) ([]Discount, error) {
	rows, err := q.db.QueryContext(ctx, listDiscounts)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []Discount
	for rows.Next() {
		var i Discount
		if err := rows.Scan(
			&i.ID,
			&i.Name,
			&i.Description,
			&i.DiscountPercent,
			&i.DiscountAmount,
			&i.DiscountType,
			&i.IsUseUnlimited,
			&i.UsePerClient,
			&i.IsActive,
			&i.ValidFrom,
			&i.ValidTo,
			&i.DurationType,
			&i.DurationMonths,
			&i.AppliesTo,
			&i.MaxRedemptions,
			&i.TimesRedeemed,
			&i.StripeCouponID,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.StripePromotionCodeID,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateDiscount = `-- name: UpdateDiscount :one
UPDATE discounts
SET name = $1,
    description = $2,
    discount_percent = $3,
    discount_amount = $4,
    discount_type = $5,
    is_use_unlimited = $6,
    use_per_client = $7,
    is_active = $8,
    valid_from = $9,
    valid_to = $10,
    duration_type = $11,
    duration_months = $12,
    applies_to = $13,
    max_redemptions = $14,
    stripe_coupon_id = $15,
    stripe_promotion_code_id = $16,
    updated_at = CURRENT_TIMESTAMP
WHERE id = $17
RETURNING id, name, description, discount_percent, discount_amount, discount_type, is_use_unlimited, use_per_client, is_active, valid_from, valid_to, duration_type, duration_months, applies_to, max_redemptions, times_redeemed, stripe_coupon_id, created_at, updated_at, stripe_promotion_code_id
`

type UpdateDiscountParams struct {
	Name                  string         `json:"name"`
	Description           sql.NullString `json:"description"`
	DiscountPercent       int32          `json:"discount_percent"`
	DiscountAmount        sql.NullString `json:"discount_amount"`
	DiscountType          string         `json:"discount_type"`
	IsUseUnlimited        bool           `json:"is_use_unlimited"`
	UsePerClient          sql.NullInt32  `json:"use_per_client"`
	IsActive              bool           `json:"is_active"`
	ValidFrom             time.Time      `json:"valid_from"`
	ValidTo               sql.NullTime   `json:"valid_to"`
	DurationType          string         `json:"duration_type"`
	DurationMonths        sql.NullInt32  `json:"duration_months"`
	AppliesTo             string         `json:"applies_to"`
	MaxRedemptions        sql.NullInt32  `json:"max_redemptions"`
	StripeCouponID        sql.NullString `json:"stripe_coupon_id"`
	StripePromotionCodeID sql.NullString `json:"stripe_promotion_code_id"`
	ID                    uuid.UUID      `json:"id"`
}

func (q *Queries) UpdateDiscount(ctx context.Context, arg UpdateDiscountParams) (Discount, error) {
	row := q.db.QueryRowContext(ctx, updateDiscount,
		arg.Name,
		arg.Description,
		arg.DiscountPercent,
		arg.DiscountAmount,
		arg.DiscountType,
		arg.IsUseUnlimited,
		arg.UsePerClient,
		arg.IsActive,
		arg.ValidFrom,
		arg.ValidTo,
		arg.DurationType,
		arg.DurationMonths,
		arg.AppliesTo,
		arg.MaxRedemptions,
		arg.StripeCouponID,
		arg.StripePromotionCodeID,
		arg.ID,
	)
	var i Discount
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Description,
		&i.DiscountPercent,
		&i.DiscountAmount,
		&i.DiscountType,
		&i.IsUseUnlimited,
		&i.UsePerClient,
		&i.IsActive,
		&i.ValidFrom,
		&i.ValidTo,
		&i.DurationType,
		&i.DurationMonths,
		&i.AppliesTo,
		&i.MaxRedemptions,
		&i.TimesRedeemed,
		&i.StripeCouponID,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.StripePromotionCodeID,
	)
	return i, err
}
